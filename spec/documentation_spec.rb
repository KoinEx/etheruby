require_relative '../lib/etheruby'

class Foo < Etheruby::Contract
  at_address 0x1234567898766543214256787654321345678
  method :bar do
    parameters array(:fixed128x128, 2)
  end
  method :baz do
    parameters :uint32, :bool
    returns good: :bool
  end
  method :sam do
    parameters :bytes, :bool, array(:uint256)
    returns good: :bool
  end
  method :f do
    parameters :uint256, array(:uint32), :bytes10, :bytes
  end
  method :mas do
    parameters :bytes,  array(:uint256, 2), :bool
  end
end

describe Foo do

  # See : https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI#examples

  it 'parses bar correctly' do
    call = {
      to: "0x1234567898766543214256787654321345678",
      data: "0xab55044d00000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000880000000000000000000000000000000"
    }
    expect(described_class).to receive(:call_api).with(call) do
      { 'result' => '0x' }
    end
    described_class.bar([2.125, 8.5])
  end

  it 'parses baz correctly' do
    call = {
      to: "0x1234567898766543214256787654321345678",
      data: "0xcdcd77c000000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000001"
    }
    expect(described_class).to receive(:call_api).with(call) do
      {'result'=>'0x0000000000000000000000000000000000000000000000000000000000000000'}
    end
    expect(described_class.baz(69,true).good).to eq(false)
  end

  it 'parses sam correctly' do
    call = {
      to: "0x1234567898766543214256787654321345678",
      data: "0xa5643bf20000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000464617665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003"
    }
    expect(described_class).to receive(:call_api).with(call) do
      {'result'=>'0x0000000000000000000000000000000000000000000000000000000000000000'}
    end
    described_class.sam("dave".codepoints, true, [1,2,3])
  end

  it 'parses f correctly' do
    call = {
      to: "0x1234567898766543214256787654321345678",
      data: "0x8be6524600000000000000000000000000000000000000000000000000000000000001230000000000000000000000000000000000000000000000000000000000000080313233343536373839300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000004560000000000000000000000000000000000000000000000000000000000000789000000000000000000000000000000000000000000000000000000000000000d48656c6c6f2c20776f726c642100000000000000000000000000000000000000"
    }
    expect(described_class).to receive(:call_api).with(call) do
      {'result'=>'0x'}
    end
    described_class.f(0x123, [0x456, 0x789], "1234567890".codepoints, "Hello, world!".codepoints)
  end

  it 'parses mas correctly' do
    call = {
      to: "0x1234567898766543214256787654321345678",
      data: "0x498e53bd000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000046461766500000000000000000000000000000000000000000000000000000000"
    }
    expect(described_class).to receive(:call_api).with(call) do
      {'result'=>'0x'}
    end
    described_class.mas("dave".codepoints, [1,2], true)
  end

end
